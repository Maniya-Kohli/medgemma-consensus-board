# üõ°Ô∏è Aegis Clinical: Multimodal AI Consensus

## üö® The Problem: "Siloed Signals"

In high-pressure clinical environments, **burnout causes blindness**. A fatigued clinician might see a "Stable" Chest X-ray and discharge a patient, missing a subtle "Wheeze" in lung audio or a "Weight Loss" note buried in history.

**Medical errors are the 3rd leading cause of death.** Many of these occur due to data disconnects‚Äîwhere critical signals are trapped in different silos.

## üõ°Ô∏è Why "Aegis Clinical"?

Named after the legendary shield of protection, **Aegis Clinical** acts as an automated "Safety Net" for healthcare providers. It serves as a clinical safeguard, employing specialized AI Agents to monitor distinct data streams (Vision, Audio, Text) and using a **Consensus Agent (MedGemma)** to shield patients from errors by detecting contradictions in real-time.

## üí° The Solution: Agentic Consensus

- **If all agents agree:** The dashboard shows Green (Low Risk).
- **If agents conflict (e.g., Vision says Healthy vs. Audio says Sick):** Aegis triggers a **RED ALERT**, forcing a critical "Second Look" before discharge.

### Hybrid Multimodal AI for Clinical Discrepancy Detection

**Consensus Board** is an agentic safety net designed to catch "hidden discrepancies" in clinical data. It uses a **Cloud-to-Edge** architecture to analyze three distinct streams‚ÄîImaging (Vision), Breath Sounds (Audio), and Clinical Notes (Text)‚Äîusing Google's specialized health models.

If a patient has a "Stable" X-ray but "New Crackles" in their audio and "Weight Loss" in their history, MedGemma triggers a **High Risk** alert, forcing a human second look before discharge.

---

## üèóÔ∏è Hybrid Architecture

### 1. The "Brain" (Cloud / Google Colab)

Running on T4 GPUs, this layer hosts the heavy-lifting models via a FastAPI server exposed through `ngrok`.

- **Visual Agent:** `google/medsiglip-448` analyzes Chest X-rays for pneumonia and stability.
- **Acoustic Agent:** `google/hear-pytorch` processes lung audio into embeddings to detect wheezes or crackles.
- **Consensus Moderator:** **MedGemma 2** (via manual tensor fusion) acts as the senior moderator, resolving contradictions between agents with robust JSON-prefilling logic.

### 2. The "Heart" (Local API)

A FastAPI backend (`apps/api/main.py`) that orchestrates the workflow:

- **Artifact Management:** Loads case data from `artifacts/runs/`.
- **Robust Parsing:** Cleans messy LLM outputs using a multi-stage parser (Markdown, JSON, and Python literal evaluation).
- **Hybrid Logic:** Combines cloud findings with local "Stub" agents for clinical history extraction.

### 3. The "Face" (Streamlit Dashboard)

A physician-facing UI (`apps/app.py`) providing:

- **Consensus Summary:** Real-time risk scoring and discrepancy alerts.
- **Case Review:** Interactive visualization of X-rays and synchronized audio playback.
- **AI Clinical Consultant:** A local chat interface (using **Ollama/Gemma 2**) for interactive case debriefing.

---

## üõ†Ô∏è Setup Instructions

### Step 1: Launch the Cloud "Brain"

1. Open the provided notebook in **Google Colab**.
2. Run the **API Server** cell. This will:

- Load MedSigLIP and HeAR models.
- Start a FastAPI server.
- Generate a public `ngrok` URL (e.g., `https://your-unique-id.ngrok-free.dev`).

### Step 2: Configure Local Environment

Create a `.env` file in the root directory:

```bash
# The URL generated by ngrok in Colab
API_URL=https://your-unique-id.ngrok-free.dev

# For the moderator fallback (optional)
HF_TOKEN=your_huggingface_token

```

### Step 3: Start the Local System

```bash
# 1. Install dependencies
pip install -r requirements.txt

# 2. Launch the Orchestrator (Terminal 1)
python -m uvicorn apps.api.main:app --reload

# 3. Launch the Dashboard (Terminal 2)
streamlit run apps/app.py

```

---

## üö¶ Usage & Workflow

1. **Select Case:** Use the sidebar to pick a case (e.g., `CASE_001`).
2. **Edit Notes:** Modify clinical history in real-time.
3. **Analyze:** Click "Analyze Case." The system will:

- Send the X-ray to the **Vision Agent** on Colab.
- Send the lung sound to the **Acoustic Agent** on Colab.
- Synthesize all findings using the **MedGemma Consensus Agent**.

4. **Consult:** If a discrepancy is found, use the **AI Consultant** tab to ask, _"Why is the risk score high given the stable imaging?"_.

---

## üì¶ Tech Stack

- **Models:** `MedSigLIP`, `HeAR`, `MedGemma 1.5`, `Gemma 2`.
- **Server:** `FastAPI`, `Uvicorn`, `ngrok`.
- **Frontend:** `Streamlit`, `Pillow`.
- **Audio:** `librosa`, `torchaudio`.
